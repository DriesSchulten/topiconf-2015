<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Topiconf 2015 - Unit-testing: praktische do's</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/night.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Unit-tests</h1>
					<h3>Praktische do's</h3>
					<p>
						<small>Dries Schulten</small>
					</p>
				</section>

				<section>
					<section>
						<h2>We kennen het allemaal...</h2>
						<img class="fragment" src="img/start_release.png"/>
					</section>
					<section>
						<h2>Wachten...</h2>
						<img src="img/release_fail.png"/>
						<img class="fragment" src="img/test_fail.png"/>
					</section>
					<section>
						<h2>Quick fix!</h2>
						<img src="img/ignore_commit.png"/>						
						<img class="fragment" src="img/release_succes.png"/>						
					</section>
				</section>

				<section>
					<section>
						<h2>Problematische tests</h2>
					</section>
					
					<section>
						<h3>De 'integratie'-unit-test</h3>
							<pre><code data-trim contenteditable>
public class FacturatieServiceTest extends AbstractSpringHibernateTest {
  @Autowired
  private FacturatieService service;
	
  @Test
  public void testFactureer() {
    Dossier dossier = super.getTestObject(Dossier.class);
    
    FacturatieStatus status = service.factureer(dossier);

    assertEquals(Status.IN_BEHANDELING, status.getStatus());
    gassertNotNull(status.getId());
  }
}
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h2>Hoe dan wel?</h2>
					</section>
					
					<section>
						<h3>Simpel voorbeeld</h3>
						<pre><code data-trim contenteditable>
@Test
public void testHeeftToegangMetGeldigeHash() {
  SecurityService service = new SecurityServiceImpl();
  String geldigeHash = maakGeldigeHash();
  assertEquals(200, service.controleerHash(geldigeHash));
}
						</code></pre>
					</section>
					
					<section>
						<h3>Mocken van dependencies <sub style="font-size: 50%;">met Mockito</sub></h3>
						<pre><code data-trim contenteditable>
@Test
public void testStartFacturatieMetDossier() {
  FacturatieDao dao = Mockito.mock(FacturatieDao.class);
  FacturatieService service = new FacturatieServiceImpl(dao);
  Dossier dossier = new Dossier();
 
  FacturatieStatus status = service.factureer(dossier);
 
  assertEquals(Status.IN_BEHANDELING, status.getStatus());
  Mockito.verify(dao).saveOrUpdate(status);
}
						</code></pre>
					</section>
					
					<section>
						<h3>Specificeren van gedrag <sub style="font-size: 50%;">met Mockito</sub></h3>
						<pre><code data-trim contenteditable>
@Test
public void testAdresOpzoekenMetOngeldigePostcode() {
  PostcodeWebService ws = mock(PostcodeWebService.class);
  PostcodeService service = new PostcodeServiceImpl(ws);
  String postcode = "123456";
  
  when(ws.getAdres(postcode)).thenThrow(new WebException(400));
  
  Optional&lt;Adres&gt; adres = service.getAdres(postcode);
  assertFalse(adres.isPresent());
}
						</code></pre>						
					</section>
					
					<section>
						<h3>Return waarden specificeren <sub style="font-size: 50%;">met Mockito</sub></h3>
						<pre><code data-trim contenteditable>
@Test
public void testAdresOpzoekenMetGeldigePostcode() {
  PostcodeWebService ws = mock(PostcodeWebService.class);
  PostcodeService service = new PostcodeServiceImpl(ws);
  String postcode = "7417ZR";
  
  Adres testAdres = new Adres("Keizerstraat", 20);
  when(ws.getAdres(postcode)).thenReturn(testAdres);
  
  Optional&lt;Adres&gt; adres = service.getAdres(postcode);
  assertTrue(adres.isPresent());
  assertEquals(testAdres, adres.get());
}
						</code></pre>							
					</section>
				</section>
				
				<section>
					<section>
						<h3>Wicket</h3>
						<p>Hoe te testen met een unit-test?</p>
					</section>
					
					<section>
						<h3>Wicket injector</h3>
						<pre><code data-trim contenteditable>
public class PatientPanel extends Panel {
  /* Op fields met @SpringBean of @Inject annotaties */
  @SpringBean
  private AdresService adresService;
	
  public PatientPanel(String id, IModel&lt;Patient&gt; model) {
    super(id, model);
		
    Adres adres = adresService.getAdres(getModelObject());
    addAdresInfo(adres);
  }
}
						</code></pre>						
					</section>
					
					<section>
						<h3>Een Mockito injector</h3>
						<pre><code data-trim contenteditable>
public class PatientPanelTest {
  @Mock
  private AdresService adresService;
  
  private WicketTester wicketTester;
	
  @Before
  public void setup() {
    Application app = new MockApplication();
    app.getComponentInstantiationListeners().add(
	    new MockitoMockInjector(app, adresService));
    wicketTester = new WicketTester(app);
  }
	
  @Test
  public void testRenderAdresVanPatientMetGeldigAdres() {
    /* setup, uitvoer en asserts */
  }
}
						</code></pre>								
					</section>
				</section>
				
				<section>
					<section>
						<h3>Hoe om te gaan met (systeem) resources</h3>
					</section>
					
					<section>
						<h3>HL7 bericht versturen met bijlage</h3>
						<pre><code data-trim contenteditable>
public class MdmVerzendServiceImpl implements MdmVerzendService {
  @Autowired
  private Hl7Verzender verzender;
	
  public void verzendMdmVoorDocument(Document document) {
    Mdm mdm = new Mdm();
    mdm.setStatus(bepaalStatus(document));
    mdm.setVerzender(bepaalVerzender(document));
    mdm.setOntvanger(bepaalOntvanger(document))
    /* ... */
	mdm.setData(laadDocumentDataAlsBase64(document));
	
    verzender.verzend(mdm);
  }

  private String laadDocumentDataAlsBase64(Document document) {
    /* Document van schijf halen en converteren met exception handling enz... */
  }
}
						</code></pre>
					</section>
					
					<section>
						<h3>Oplossing <sub class="fragment" style="font-size: 50%;">toch?</sub></h3>
						<pre><code data-trim contenteditable>
public void testVerzendMdmMetOntvanger() {
  File testDocument = new File(getClass.getResource("/test_document.pdf").toURI());
  final String ontvangerCode = "0956124";	
  Document document = new Document("Overdracht");
  document.setOnvangerCode(ontvangerCode);
  document.setBestandsLocatie(testDocument.getAbsolutePath());
  
  mdmVerzendService.verzendMdmVoorDocument(document);

  ArgumentCaptor&lt;Hl7Message&gt; argument = ArgumentCaptor.forClass(Hl7Message.class);
  verify(verzender).verzend(argument.capture());
  assertEquals(ontvangerCode, argument.getValue().getReceiverCode());
}
						</code></pre>						
					</section>
					
					<section>
						<h3>De betere oplossing (1)</h3>
						<pre><code data-trim contenteditable>
public interface DocumentIO {
  String laadDocumentDataAlsBase64(Document document);
}

public class MdmVerzendServiceImpl implements MdmVerzendService {
  @Autowired
  private DocumentIO documentIO;
  @Autowired
  private Hl7Verzender verzender;
	
  public void verzendMdmVoorDocument(Document document) {
    Mdm mdm = new Mdm();
    mdm.setStatus(bepaalStatus(document));
    mdm.setVerzender(bepaalVerzender(document));
    mdm.setOntvanger(bepaalOntvanger(document))
    /* ... */
    mdm.setData(documentIO.laadDocumentDataAlsBase64(document));
	
    verzender.verzend(mdm);
  }	
}
						</code></pre>						
					</section>
					
					<section>
						<h3>De betere oplossing (2)</h3>
						<pre><code data-trim contenteditable>
public void testVerzendMdmMetOntvanger() {
  final String ontvangerCode = "0956124";	
  Document document = new Document("Overdracht");
  document.setOnvangerCode(ontvangerCode);
  
  when(documentIO.laadDocumentDataAlsBase64(any(Document.class)))
      .thenReturn("Document inhoud");
  
  mdmVerzendService.verzendMdmVoorDocument(document);

  ArgumentCaptor&lt;Hl7Message&gt; argument = ArgumentCaptor.forClass(Hl7Message.class);
  verify(verzender).verzend(argument.capture());
  assertEquals(ontvangerCode, argument.getValue().getReceiverCode());
}
						</code></pre>
					</section>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				center: true,
				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
